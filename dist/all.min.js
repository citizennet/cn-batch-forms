"use strict";function _defineProperty(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}!function(){angular.module("cn.batch-forms",["schemaForm","cn.flex-form","cn.util","ui.router"])}(),function(){function e(e,t,s){function i(){a.config.idParam&&a.results.forEach(function(t,i){if(_.isFunction(a.config.buildEditSref))t.editSref=a.config.buildEditSref(t.body,i);else{var n=_.assign({},s,_defineProperty({},a.config.idParam,a.originals[i].id));t.editSref=e.current.name+"("+angular.toJson(n)+")"}}),a.headerConfig={title:{main:"Batch Results"},actionConfig:{actions:[{text:"Continue Editing"},{text:"Done",handler:function(){a.config&&a.config.returnState&&e.go(a.config.returnState.name,a.config.returnState.params)}}]},noData:!0}}function n(e){return e.editSref&&_.inRange(e.status,200,299)}function r(e){a.parent.closeModal(),e&&e()}var a=this;a.parent=t,a.results=a.parent.results,a.originals=a.parent.models,a.config=a.parent.resultsConfig,a.displayName=a.config&&a.config.displayName||"name",a.formName=e.current.name,a.text=a.config.text,a.activate=i,a.showEdit=n,a.submit=r,a.activate()}angular.module("cn.batch-forms").controller("BatchResults",e),e.$inject=["$state","parent","$stateParams"]}(),function(){function e(e){e.registerField({condition:function(e){return e.type===s},handler:function(e){},type:s,templateUrl:i})}function t(e){e.put(i,'        <div class="checkbox cn-dirty-check {{form.htmlClass}}">          <input type="checkbox"                 ng-model="$$value$$"                 ng-model-options="form.ngModelOptions"                 sf-changed="form"                 ng-disabled="form.readonly"                 name="{{form.key.slice(-1)[0]}}"/>        </div>')}angular.module("cn.batch-forms").config(e).run(t);var s="cn-dirty-check",i="cn-batch-forms/cn-dirty-check.html";e.$inject=["cnFlexFormServiceProvider"],t.$inject=["$templateCache"]}(),function(){function e(){function e(e){e.handler&&(s[e.type]=e.handler)}return{registerField:e,$get:t}}function t(e,t,i,n,r,a,o){function c(e,t,s){if(!s.length)return e;var i=l(e,t,s);return i}function l(e,t,s){return Object.create({constructor:d,addMeta:z,addToSchema:F,clearSchemaDefault:K,closeModal:J,createDirtyCheck:x,createBatchField:v,getChangedModels:D,getEditModeLegends:G,getFormFromRegister:C,getModelValues:$,getSchemaDefault:b,getTitleMap:y,handleLinks:M,onFieldScope:h,onReprocessField:S,processCondition:m,processDiff:f,processSchemaDiff:u,processSchema:B,processField:g,processItems:p,processDate:T,processDefault:q,processLinkList:R,processLinks:w,processNumber:L,processSelect:A,processToggle:I,registerFieldWatch:E,resetDefaults:O,restoreDefaults:W,setValidation:k,setValue:V,showResults:U}).constructor(e,t,s)}function d(t,s,i){if(this.instance=H,H++,this.schema=t,this.model=s,this.models=i,this.defaults={},this.editModes={},this.fieldRegister={},this.processSchema(),e.onProcessDiff=this.processDiff.bind(this),t.forms)for(var n=t.forms.length-1;n>-1;)this.processItems(t.forms[n].form),t.forms[n].form.length||t.forms.splice(n,1),--n;else this.processItems(t.form);return this.addMeta(),this.processLinks(),r.$on("schemaFormPropagateScope",this.onFieldScope.bind(this)),r.$on("cnFlexFormReprocessField",this.onReprocessField.bind(this)),console.info("BatchDone:",t,s,i),this}function h(e,s){var i=t.getKey(s.form.key);if(i.startsWith("__"))"__batchConfig"===s.form.key[0]&&(s.ngModel.$pristine=!1);else{this.fieldRegister[i]||(this.fieldRegister[i]={});var n=this.fieldRegister[i];n.ngModel=s.ngModel,n.scope=s,this.fieldRegister[i].field||(this.fieldRegister[i].field=s.form)}}function f(e){var t=e.params.updateSchema,s=_.filter(e.batchConfig.links,function(e){return _.startsWith(e,t)}),i=_.filter(e.batchConfig.hardLinks,function(e){return _.startsWith(e,t)});u.call(this,e.diff.schema,_.flatten(s.concat(i)))}function u(e,t){var s=this,i=_.keys(e);_.forEach(i,function(i){_.has(e[i],"properties")?u.call(s,e[i].properties,t):_.has(e[i],"items")?u.call(s,e[i].items,t):_.every(t,function(e){return!_.includes(e,i)})&&K.call(s,e[i])})}function p(e){for(var t=e.length-1;t>-1;){var s=this.processField(e[t]);if(s&&s.batchConfig){"fieldset"!==s.type&&(s.htmlClass=(s.htmlClass||"")+" cn-batch-field clearfix");var i=this.createBatchField(s),n=s.key&&this.createDirtyCheck(s);e[t]={type:"section",htmlClass:"cn-batch-wrapper",items:n?[s,n,i]:[s,i],condition:this.processCondition(s.condition)},delete s.condition,s.key&&(this.fieldRegister[s.key]||(this.fieldRegister[s.key]={}),this.fieldRegister[s.key].field=s,this.fieldRegister[s.key].dirtyCheck=n)}s||e.splice(t,1),--t}}function m(e){return e&&e.replace(/\b(model)\.(\S*)\b/g,'($1.$2 === undefined ? $1.__ogValues["$2"] : $1.$2)')}function g(e){if(e.key){if(!e.batchConfig)return!1;e._key=e.key,e._placeholder=e.placeholder,e.schema=e.schema||t.getSchema(e.key,this.schema.schema.properties),e.type=e.type||e.schema.type,delete e.required,e.resolve&&delete e.resolve.required,e.conditionals&&delete e.conditionals.required;var n=i.getFieldType(e),r=s[n];if(r){if(_.isString(r)&&(r=this[r]),_.isObject(e.batchConfig)||(e.batchConfig={}),e.batchConfig.ogValues=this.getModelValues(e),_.allEqual(e.batchConfig.ogValues)){var a='__ogValues["'+e.key+'"]',o=_.first(e.batchConfig.ogValues);t.parseExpression(a,this.model).set(o)}return r.bind(this)(e)}return!1}if(e.items){if(e.batchConfig&&e.items.forEach(function(t){t.batchConfig=_.clone(e.batchConfig)}),this.processItems(e.items),!e.items.length)return!1;e.batchConfig&&(_.isObject(e.batchConfig)||(e.batchConfig={}),e.batchConfig.key="component_"+_.uniqueId(),e.batchConfig.watch=[],e.items.forEach(function(t,s){var i=t.items[0];s||(e.batchConfig.editModes=i.batchConfig.editModes,e.batchConfig["default"]=i.batchConfig["default"]),e.batchConfig.watch.push({resolution:'model.__batchConfig["'+i.key+'"] = model.__batchConfig["'+e.batchConfig.key+'"]'}),t.items[2].htmlClass="hide"}))}return e}function y(e){var t=this;return e=e||["replace"],e.map(function(e){return t.editModes[e]=!0,{name:_.capitalize(e),value:e}})}function b(e){return e||"replace"}function v(e){var t=e.batchConfig,s='__batchConfig["'+(e.key||t.key)+'"]',i={key:s,type:"radiobuttons",titleMap:this.getTitleMap(t.editModes),htmlClass:"cn-batch-options",btnClass:"btn-sm cn-no-dirty-check",watch:t.watch||[]};return 1===i.titleMap.length&&(i.htmlClass="hide"),this.addToSchema(s,{type:"string",title:"Edit Mode","default":this.getSchemaDefault(t["default"])}),t.onSelect&&i.watch.push({resolution:function(e,s){e&&t.onSelect[e](s)}}),i}function k(e,s){var i=this,n=t.getKey(e.key);e.schema&&"array"===e.schema.type&&(_.isUndefined(e.schema._minItems)&&(e.schema._minItems=e.schema.minItems),e.schema.minItems=s?e.schema._minItems:0);var r=n?this.getFormFromRegister(n):[];r.forEach(function(e){e.scope&&(e.scope.options=e.scope.options||{},e.scope.options.tv4Validation=s,Object.keys(e.ngModel.$error).filter(function(e){return 0===e.indexOf("tv4-")}).forEach(function(t){e.ngModel.$setValidity(t,!0)}))}),e.items&&e.items.forEach(function(e){return i.setValidation(e,s)})}function C(e){if(e.includes("[]")){var t=new RegExp(e.replace("[]","\\[\\d*\\]"));return _.filter(this.fieldRegister,function(e,s){return t.test(s)})}return this.fieldRegister[e]?[this.fieldRegister[e]]:[]}function x(e){var s=this,i='__dirtyCheck["'+(e.key||e.batchConfig.key)+'"]',n="";!e.notitle&&e.schema.title||(n+=" notitle");var a={key:i,htmlClass:n,type:"cn-dirty-check",watch:[{resolution:function(t){s.setValidation(e,t),r.$broadcast("schemaFormValidate")}}]};return this.addToSchema(i,{type:"boolean",notitle:!0}),a.fieldWatch={resolution:function(n){var r=s.fieldRegister[e._key];r?_.get(r,"ngModel.$dirty")&&t.parseExpression(i,s.model).set(!0):console.debug("no register:",e,s.fieldRegister)}},this.registerFieldWatch(e,a.fieldWatch),a}function E(e,t){e.watch?_.isArray(e.watch)||(e.watch=[e.watch]):e.watch=[],e.watch.push(t)}function S(e,t){var s=this.fieldRegister[t];return s?void(s.dirtyCheck&&this.registerFieldWatch(s.field,s.dirtyCheck.fieldWatch)):console.debug("no register:",t,this.fieldRegister)}function M(e,s){var i=this;return function(n){e.forEach(function(e){if(!s){var r=i.fieldRegister[e];if(!_.get(r,"ngModel.$dirty"))return}t.parseExpression('__dirtyCheck["'+e+'"]',i.model).set(n)})}}function R(e,t){var s=this;e.forEach(function(e){e.forEach(function(i){var n=s.fieldRegister[i];if(!n)return void console.debug("no register:",i);var r=n.field,a=n.dirtyCheck,o=s.handleLinks(_.without(e,i),t);r.watch=r.watch||[],a.watch=a.watch||[],r.watch.push({resolution:function(){o(!0)}}),a.watch.push({resolution:o})})})}function w(){this.schema.batchConfig&&(this.schema.batchConfig.links&&this.processLinkList(this.schema.batchConfig.links),this.schema.batchConfig.hardLinks&&this.processLinkList(this.schema.batchConfig.hardLinks,!0))}function F(e,t){var s=n.parse(e),i=this.schema.schema;s.forEach(function(e,n){n===s.length-1?(i.properties||(i.properties={}),i.properties[e]=t):""===e?(i.items||(i.items={type:"object"}),i=i.items):(i.properties||(i.properties={}),i.properties[e]||(i.properties[e]={type:"object"}),i=i.properties[e])})}function $(e){return this.models.map(function(s){return t.parseExpression(e.key,s).get()})}function D(){var e=this,s=[];return _.each(this.fieldRegister,function(i,r){var a=t.parseExpression('__dirtyCheck["'+r+'"]',e.model).get();if(a){var o=t.parseExpression('__batchConfig["'+r+'"]',e.model).get();e.models.forEach(function(i,a){s[a]=s[a]||{};var c=n.parse(r);c.length>1&&!s[a][c[0]]&&(s[a][c[0]]=e.models[a][c[0]]);var l=t.parseExpression(r,e.models[a]).getAssignable();if(l.fullPath!==r){var d=t.parseExpression(l.fullPath,e.model).get();t.parseExpression(l.fullPath,e.models[a]).set(d)}else{var h=t.parseExpression(r,e.model).get(),f=t.parseExpression(r,s[a]),u=t.parseExpression(r,e.models[a]);e.setValue(h,f,u,o)}})}}),s}function V(e,s,i,n){if("replace"===n)s.set(e);else if("append"===n){var r=i.get();if(_.isArray(r)){var a=_([]).concat(r,e).uniq(function(e){return e.key||angular.toJson(e)}).value();s.set(a)}else _.isString(r)?s.set(r+" "+e.trim()):s.set(e)}else if("prepend"===n){var o=i.get();_.isArray(o)?s.set(e.concat(o)):_.isString(o)?s.set(e.trim()+" "+o):s.set(e)}else if("increase"===n)s.set(_.add(i.get()||0,e));else if("decrease"===n)s.set(_.subtract(i.get()||0,e));else if("stringReplace"===n&&i.get()){var c=i.path().key,l=t.parseExpression("_replace_"+c,this.model),d=t.parseExpression("_with_"+c,this.model),h=new RegExp(_.escapeRegExp(l.get()),"gi");s.set(i.get().replace(h,d.get()))}}function P(e,t){e.noBatchPlaceholder||(e.placeholder=t)}function q(e){var s=this,i=e.batchConfig;if(i.editModes=i.editModes||["replace","prepend","append","stringReplace"],i["default"]=i["default"]||"append",i.editModes.includes(i["default"])||(i["default"]=i.editModes[0]),i.onSelect={replace:function(){_.allEqual(i.ogValues)?t.parseExpression(e.key,s.model).set(_.first(i.ogValues),{silent:!0}):P(e,"—")},append:function(){P(e,"")},prepend:function(){P(e,"")},stringReplace:function(){}},i.editModes.includes(i["default"])&&i.onSelect[i["default"]](),i.editModes.includes("stringReplace")){var n=this.createDirtyCheck(e),r='__batchConfig["'+(e.key||e.batchConfig.key)+'"]',a="_replace_"+(e.key||e.batchConfig.key),o="_with_"+(e.key||e.batchConfig.key),c={type:"component",items:[{key:a,title:"Replace",watch:{resolution:"model."+n.key+" = true"}},{key:o,title:"With",watch:{resolution:"model."+n.key+" = true"}}],condition:"model."+r+" === 'stringReplace'"};return i.key=e.key,this.addToSchema(a,{type:"string"}),this.addToSchema(o,{type:"string"}),{type:"section",condition:e.condition,batchConfig:i,schema:e.schema,items:[_.extend(e,{condition:"model."+r+" !== 'stringReplace'"}),c,n]}}return e}function L(e){var s=e.batchConfig;return s.editModes=s.editModes||["replace","decrease","increase"],_.allEqual(s.ogValues)?t.parseExpression(e.key,this.model).set(_.first(s.ogValues),{silent:!0}):e.placeholder="—",e}function j(e){e.items||P(e,"—")}function A(e){var s=this,i=e.schema.type,n=e.batchConfig;if("array"===i)n.editModes=n.editModes||["replace","append"],n["default"]=n["default"]||"replace",_.allEqual(n.ogValues)?a(function(){return t.parseExpression(e.key,s.model).set(_.first(angular.copy(n.ogValues)),{silent:!0})}):j(e),n.onSelect={replace:function(i){i&&"append"!==i&&t.parseExpression(e.key,s.model).set([])},append:function(i){"replace"!==i&&t.parseExpression(e.key,s.model).set([])},remove:function(){var i=_.chain(e.batchConfig.ogValues).flatten().uniq().value();t.parseExpression(e.key,s.model).set(i,{silent:!0})}};else{var r=_.first(n.ogValues);r&&_.allEqual(n.ogValues)&&t.parseExpression(e.key,this.model).set(r,{silent:!0}),e.placeholder||P(e,"—")}return e}function T(e){var s=e.batchConfig;return _.allEqual(s.ogValues)?t.parseExpression(e.key,this.model).set(_.first(s.ogValues,{silent:!0})):P(e,"—"),e}function I(e){var s=e.batchConfig;return _.allEqual(s.ogValues)&&t.parseExpression(e.key,this.model).set(_.first(s.ogValues,{silent:!0})),e}function B(){var e=this;this.schema.schema.required=void 0,_.each(this.schema.schema.properties,this.clearSchemaDefault.bind(this)),this.schema.schema.properties.__batchConfig={type:"object",properties:{}},this.schema.schema.properties.__dirtyCheck={type:"object",properties:{}},r.$on("schemaFormBeforeAppendToArray",function(t,s){return e.restoreDefaults(s)}),r.$on("schemaFormAfterAppendToArray",function(t,s){return e.resetDefaults(s)})}function W(e){var s=this;e.items&&(e.items.forEach(function(e){if(e.key&&e.schema){var i=t.getKey(e.key).replace(/\[\d+]/g,"[]");e.schema["default"]=s.defaults[i]}s.restoreDefaults(e)}),N(e.items))}function N(e){_.each(e,function(e){e.placeholder=e._placeholder,e.noBatchPlaceholder=!0,e.items&&N(e.items)})}function O(e){var t=this;e.items&&e.items.forEach(function(e){e.schema&&(e.schema["default"]=void 0),t.resetDefaults(e)})}function K(e,t){if(this.defaults[t]=e["default"],e["default"]=void 0,"object"===e.type&&e.properties){e.required=void 0;for(var s in e.properties)this.clearSchemaDefault(e.properties[s],t+"."+s)}else"array"===e.type&&e.items&&this.clearSchemaDefault(e.items,t+"[]")}function U(e,t){var s=this;this.results=e,this.resultsConfig=t,this.modal&&this.modal.close(),this.modal=o.open({controller:"BatchResults",controllerAs:"vm",templateUrl:"cn-batch-forms/batch-results.html",resolve:{parent:function(){return s}}})}function J(){this.modal.close(),this.results=[],this.resultsConfig=null}function z(){this.schema.meta='\n          <div class="well">\n            <h5>Edit Modes</h5>\n            <p>Some types of fields allow you to apply batch changes in\n            different ways:</p>\n            <dl>\n              <dt>Replace:</dt>\n              <dd>Replace all the original values\n              with the new value. <em>(If you don\'t see an <b>Edit Mode</b> option\n              for a field, this will be the default)</em></dd>\n            </dl>\n            '+this.getEditModeLegends()+"\n          </div>"}function G(){var e="";return this.editModes.prepend&&(e+="\n            <dl>\n              <dt>Prepend:</dt>\n              <dd>Add the new value to the start of the original\n              values for each item.</dd>\n            </dl>"),this.editModes.append&&(e+="\n            <dl>\n              <dt>Append:</dt>\n              <dd>Affix the new value at the end of the original\n              values for each item.</dd>\n            </dl>"),this.editModes.decrease&&(e+="\n            <dl>\n              <dt>Decrease:</dt>\n              <dd>Subtract the given value from the original\n              values for each item.</dd>\n            </dl>"),this.editModes.increase&&(e+="\n            <dl>\n              <dt>Increase:</dt>\n              <dd>Add the given value to the original\n              values for each item.</dd>\n            </dl>"),e}var H=0;return{augmentSchema:c}}angular.module("cn.batch-forms").provider("cnBatchForms",e);var s={string:"processDefault",number:"processNumber",url:"processDefault",array:"processSelect","cn-autocomplete":"processSelect","cn-currency":"processNumber","cn-datetimepicker":"processDate","cn-toggle":"processToggle"};t.$inject=["cnFlexFormConfig","cnFlexFormService","cnFlexFormTypes","sfPath","$rootScope","$timeout","cnModal"]}(),angular.module("cn.batch-forms").run(["$templateCache",function(e){e.put("cn-batch-forms/batch-results.html",'<div class="cn-modal">\n  <div class="modal-header clearfix">\n    <cn-flex-form-header\n      ff-header-config="vm.headerConfig"\n      ff-submit="vm.submit(handler)">\n    </cn-flex-form-header>\n  </div>\n  <div class="modal-body cn-list card-flex"\n       cn-responsive-height="80"\n       cn-responsive-break="sm"\n       cn-set-max-height>\n\n    <div class="padding-20"\n         ng-if="vm.text">\n      <p class="no-margin text-mute"\n         ng-bind-html="vm.text">\n      </p>\n    </div>\n\n    <table class="table gutterless">\n      <tbody>\n      <tr ng-repeat="result in vm.results">\n        <td class="col-sm-10">\n          <h6 ng-show="result.status == 200">\n            {{result.body[vm.displayName]}}\n            <span class="text-mute">({{result.body.id}})</span>\n          </h6>\n          <h6 ng-show="result.status != 200">\n            {{vm.originals[$index][vm.displayName]}}\n            <span class="text-mute">({{vm.originals[$index].id}})</span>\n          </h6>\n          <p ng-class="{\n               \'text-danger\': result.status != 200,\n               \'text-primary\': result.status == 200\n             }">\n            <i class="fa fa-{{result.status == 200 ? \'check\' : \'times\'}}"></i>\n            {{result.status == 200 ? \'updated successfully\' : result.body.message}}\n          </p>\n        </td>\n        <td class="col-sm-2 text-center">\n          <a class="btn btn-sm btn-transparent"\n             ng-show="vm.showEdit(result)"\n             ui-sref="{{ result.editSref }}">\n            <i class="icn-edit"></i>\n          </a>\n        </td>\n      </tr>\n      </tbody>\n    </table>\n  </div>\n</div>\n')}]);
//# sourceMappingURL=all.min.js.map
