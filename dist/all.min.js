"use strict";function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(){angular.module("cn.batch-forms",["schemaForm","cn.flex-form","cn.util","ui.router"])}(),function(){function e(e,t,i){function n(){console.log("vm.parent:",r.parent),r.config.idParam&&r.results.forEach(function(t,n){var s=_.assign({},i,_defineProperty({},r.config.idParam,r.originals[n].id));t.editSref=e.current.name+"("+angular.toJson(s)+")",console.log("result.editSref:",t)}),r.headerConfig={title:{main:"Batch Results"},actionConfig:{actions:[{text:"Continue Editing"},{text:"Done",handler:function(){r.config&&r.config.returnState&&e.go(r.config.returnState.name,r.config.returnState.params)}}]},noData:!0}}function s(e){console.log("submit:",e),r.parent.closeModal(),e&&e()}var r=this;r.parent=t,r.results=r.parent.results,r.originals=r.parent.models,r.config=r.parent.resultsConfig,r.displayName=r.config&&r.config.displayName||"name",r.formName=e.current.name,r.text=r.config.text,r.activate=n,r.submit=s,r.activate()}angular.module("cn.batch-forms").controller("BatchResults",e),e.$inject=["$state","parent","$stateParams"]}(),function(){function e(e){e.registerField({condition:function(e){return e.type===i},handler:function(e){},type:i,templateUrl:n})}function t(e){e.put(n,'        <div class="checkbox cn-dirty-check {{form.htmlClass}}">          <input type="checkbox"                 ng-model="$$value$$"                 ng-model-options="form.ngModelOptions"                 sf-changed="form"                 ng-disabled="form.readonly"                 name="{{form.key.slice(-1)[0]}}"/>        </div>')}angular.module("cn.batch-forms").config(e).run(t);var i="cn-dirty-check",n="cn-batch-forms/cn-dirty-check.html";e.$inject=["cnFlexFormServiceProvider"],t.$inject=["$templateCache"]}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};!function(){function e(){function e(e){e.handler&&(i[e.type]=e.handler)}return{registerField:e,$get:t}}function t(e,t,n,s,r,o){function a(e,t,i){if(!i.length)return e;var n=c(e,t,i);return n}function c(e,t,i){return Object.create({constructor:l,addMeta:U,addToSchema:R,buildModelDefault:w,clearSchemaDefault:O,closeModal:K,createDirtyCheck:k,createBatchField:y,getChangedModels:$,getEditModeLegends:z,getFormFromRegister:v,getModelValues:F,getSchemaDefault:g,getTitleMap:m,handleLinks:E,onFieldScope:d,onReprocessField:x,processCondition:u,processSchema:B,processForm:h,processField:p,processItems:f,processDate:L,processDefault:P,processLinkList:M,processLinks:S,processNumber:j,processSelect:A,processToggle:T,registerFieldWatch:C,resetDefaults:N,restoreDefaults:I,setValidation:b,setValue:V,showResults:W}).constructor(e,t,i)}function l(e,t,i){if(console.log("BatchForms:",e,t,i),this.instance=J,J++,this.schema=e,this.model=t,this.models=i,this.defaults={},this.editModes={},this.fieldRegister={},this.processSchema(),e.forms)for(var n=e.forms.length-1;n>-1;)this.processForm(e.forms[n]),e.forms[n].form.length||e.forms.splice(n,1),--n;else this.processForm(e.form);return this.addMeta(),this.processLinks(),s.$on("schemaFormPropagateScope",this.onFieldScope.bind(this)),s.$on("cnFlexFormReprocessField",this.onReprocessField.bind(this)),console.log("BatchDone:",e,t,i),this}function d(t,i){var n=e.getKey(i.form.key);n.startsWith("__")?"__batchConfig"===i.form.key[0]&&(i.ngModel.$pristine=!1):(this.fieldRegister[n]||(this.fieldRegister[n]={}),this.fieldRegister[n].ngModel=i.ngModel,this.fieldRegister[n].scope=i)}function h(e){this.processItems(e,"form")}function f(e){for(var t=arguments.length<=1||void 0===arguments[1]?"items":arguments[1],i=e[t].length-1;i>-1;){var n=this.processField(e[t][i]);if(n&&n.batchConfig){n.htmlClass=(n.htmlClass||"")+" cn-batch-field clearfix";var s=this.createBatchField(n),r=n.key&&this.createDirtyCheck(n);e[t][i]={type:"section",htmlClass:"cn-batch-wrapper",items:r?[n,r,s]:[n,s],condition:this.processCondition(n.condition)},delete n.condition,this.fieldRegister[n.key]||(this.fieldRegister[n.key]={}),this.fieldRegister[n.key].field=n,this.fieldRegister[n.key].dirtyCheck=r}n||e[t].splice(i,1),--i}}function u(e){return e&&e.replace(/\b(model)\.(\S*)\b/g,'($1.$2 === undefined ? $1.__ogValues["$2"] : $1.$2)')}function p(n){if(n.key){if(!n.batchConfig)return!1;n._key=n.key,n._placeholder=n.placeholder,console.log("field._placeholder:",n._placeholder),n.schema=n.schema||e.getSchema(n.key,this.schema.schema.properties),n.type=n.type||n.schema.type,delete n.required,n.conditionals&&delete n.conditionals.required;var s=t.getFieldType(n),r=i[s];if(r){if(_.isString(r)&&(r=this[r]),_.isObject(n.batchConfig)||(n.batchConfig={}),n.batchConfig.ogValues=this.getModelValues(n),_.allEqual(n.batchConfig.ogValues)){var o='__ogValues["'+n.key+'"]',a=_.first(n.batchConfig.ogValues);e.parseExpression(o,this.model).set(a)}return r.bind(this)(n)}return!1}if(n.items){if(n.batchConfig&&n.items.forEach(function(e){e.batchConfig=_.clone(n.batchConfig)}),this.processItems(n),!n.items.length)return!1;n.batchConfig&&(_.isObject(n.batchConfig)||(n.batchConfig={}),n.batchConfig.key="component_"+_.uniqueId(),n.batchConfig.watch=[],n.items.forEach(function(e,t){var i=e.items[0];t||(n.batchConfig.editModes=i.batchConfig.editModes,n.batchConfig["default"]=i.batchConfig["default"]),n.batchConfig.watch.push({resolution:'model.__batchConfig["'+i.key+'"] = model.__batchConfig["'+n.batchConfig.key+'"]'}),e.items[2].condition="false"}))}return n}function m(e){var t=this;return e=e||["replace"],e.map(function(e){return t.editModes[e]=!0,{name:_.capitalize(e),value:e}})}function g(e){return e||"replace"}function y(e){var t=e.batchConfig,i='__batchConfig["'+(e.key||t.key)+'"]',n={key:i,type:"radiobuttons",titleMap:this.getTitleMap(t.editModes),htmlClass:"cn-batch-options",btnClass:"btn-sm cn-no-dirty-check",watch:t.watch||[]};return 1===n.titleMap.length&&(n.condition="false"),this.addToSchema(i,{type:"string",title:"Edit Mode","default":this.getSchemaDefault(t["default"])}),t.onSelect&&n.watch.push({resolution:function(e,i){e&&t.onSelect[e](i)}}),n}function b(t,i){var n=this,s=e.getKey(t.key);t.schema&&"array"===t.schema.type&&(_.isUndefined(t.schema._minItems)&&(t.schema._minItems=t.schema.minItems),t.schema.minItems=i?t.schema._minItems:0);var r=s?this.getFormFromRegister(s):[];r.forEach(function(e){e.scope&&(e.scope.options={tv4Validation:i},Object.keys(e.ngModel.$error).filter(function(e){return 0===e.indexOf("tv4-")}).forEach(function(t){e.ngModel.$setValidity(t,!0)}))}),t.items&&t.items.forEach(function(e){return n.setValidation(e,i)})}function v(e){var t=this;if(!e.includes("[]"))return this.fieldRegister[e]?[this.fieldRegister[e]]:[];var i=function(){var i=new RegExp(e.replace("[]","\\[\\d*\\]"));return{v:_.filter(t.fieldRegister,function(e,t){return i.test(t)})}}();return"object"===("undefined"==typeof i?"undefined":_typeof(i))?i.v:void 0}function k(t){var i=this,n='__dirtyCheck["'+(t.key||t.batchConfig.key)+'"]',r="";!t.notitle&&t.schema.title||(r+=" notitle");var o={key:n,htmlClass:r,type:"cn-dirty-check",watch:[{resolution:function(e){i.setValidation(t,e),s.$broadcast("schemaFormValidate")}}]};this.addToSchema(n,{type:"boolean",notitle:!0});var a=this.buildModelDefault(t.key,t.schema)||{};return o.fieldWatch={resolution:function(s){if(!angular.equals(s,a[t._key])){var r=i.fieldRegister[t._key];r?r.ngModel&&r.ngModel.$dirty||r.initiated?e.parseExpression(n,i.model).set(!0):r.initiated=!0:console.log("noregister:",t,i.fieldRegister)}}},this.registerFieldWatch(t,o.fieldWatch),o}function C(e,t){e.watch?_.isArray(e.watch)||(e.watch=[e.watch]):e.watch=[],e.watch.push(t)}function x(e,t){var i=this.fieldRegister[t];this.registerFieldWatch(i.field,i.dirtyCheck.fieldWatch)}function E(t,i){var n=this;return function(s){t.forEach(function(t){if(!i){var r=n.fieldRegister[t];if(!r.ngModel||!r.ngModel.$dirty)return}e.parseExpression('__dirtyCheck["'+t+'"]',n.model).set(s)})}}function M(e,t){var i=this;e.forEach(function(e){e.forEach(function(n){var s=i.fieldRegister[n];if(!s)return void console.error("noRegister:",n);var r=s.field,o=s.dirtyCheck,a=i.handleLinks(_.without(e,n),t);r.watch=r.watch||[],o.watch=o.watch||[],r.watch.push({resolution:function(){a(!0)}}),o.watch.push({resolution:a})})})}function S(){console.log("this.schema.batchConfig:",this.schema.batchConfig),this.schema.batchConfig&&(this.schema.batchConfig.links&&this.processLinkList(this.schema.batchConfig.links),this.schema.batchConfig.hardLinks&&this.processLinkList(this.schema.batchConfig.hardLinks,!0))}function w(e,t){if("array"===t.type){var i=function(){var i=_defineProperty({},e,[]);return t.items&&_.each(t.items.properties,function(t,n){"array"===t.type&&i[e].push(w(n,t))}),{v:i}}();if("object"===("undefined"==typeof i?"undefined":_typeof(i)))return i.v}}function R(e,t){var i=n.parse(e),s=this.schema.schema;i.forEach(function(e,n){n===i.length-1?(s.properties||(s.properties={}),s.properties[e]=t):""===e?(s.items||(s.items={type:"object"}),s=s.items):(s.properties||(s.properties={}),s.properties[e]||(s.properties[e]={type:"object"}),s=s.properties[e])})}function F(t){return this.models.map(function(i){return e.parseExpression(t.key,i).get()})}function $(){var t=this,i=[];return _.each(this.fieldRegister,function(s,r){var o=e.parseExpression('__dirtyCheck["'+r+'"]',t.model).get();if(o){var a=e.parseExpression('__batchConfig["'+r+'"]',t.model).get();t.models.forEach(function(s,o){i[o]=i[o]||{};var c=n.parse(r);c.length>1&&!i[o][c[0]]&&(i[o][c[0]]=t.models[o][c[0]]);var l=e.parseExpression(r,t.models[o]).getAssignable();if(l.fullPath!==r){var d=e.parseExpression(l.fullPath,t.model).get();e.parseExpression(l.fullPath,t.models[o]).set(d)}else{var h=e.parseExpression(r,t.model).get(),f=e.parseExpression(r,i[o]),u=e.parseExpression(r,t.models[o]);t.setValue(h,f,u,a)}})}}),i}function V(t,i,n,s){if("replace"===s)i.set(t);else if("append"===s){var r=n.get();if(_.isArray(r)){var o=_([]).concat(r,t).uniq(function(e){return e.key||e}).value();i.set(o)}else _.isString(r)?i.set(r+" "+t.trim()):i.set(t)}else if("prepend"===s){var a=n.get();_.isArray(a)?i.set(t.concat(a)):_.isString(a)?i.set(t.trim()+" "+a):i.set(t)}else if("increase"===s)i.set(_.add(n.get()||0,t));else if("decrease"===s)i.set(_.subtract(n.get()||0,t));else if("stringReplace"===s&&n.get()){var c=n.path().key,l=e.parseExpression("_replace_"+c,this.model),d=e.parseExpression("_with_"+c,this.model);i.set(n.get().replace(l.get(),d.get()))}}function D(e,t){e.noBatchPlaceholder||(e._placeholder=t)}function P(t){var i=this,n=t.batchConfig;if(n.editModes=n.editModes||["replace","prepend","append","stringReplace"],n["default"]=n["default"]||"append",n.editModes.includes(n["default"])||(n["default"]=n.editModes[0]),n.onSelect={replace:function(){_.allEqual(n.ogValues)?e.parseExpression(t.key,i.model).set(_.first(n.ogValues)):D(t,"—")},append:function(){D(t,"")},prepend:function(){D(t,"")},stringReplace:function(){}},n.editModes.includes("stringReplace")){var s='__dirtyCheck["'+(t.key||t.batchConfig.key)+'"]',r='__batchConfig["'+(t.key||t.batchConfig.key)+'"]',o="_replace_"+(t.key||t.batchConfig.key),a="_with_"+(t.key||t.batchConfig.key),c={type:"component",items:[{key:o,title:"Replace",watch:{resolution:"model."+s+" = true"}},{key:a,title:"With",watch:{resolution:"model."+s+" = true"}}],condition:"model."+r+" === 'stringReplace'"};n.key=t.key,t={type:"section",condition:t.condition,batchConfig:n,schema:t.schema,key:t.key,items:[_.extend(t,{condition:"model."+r+" !== 'stringReplace'"}),c]},this.addToSchema(o,{type:"string"}),this.addToSchema(a,{type:"string"})}return t}function j(t){var i=t.batchConfig;return i.editModes=i.editModes||["replace","decrease","increase"],_.allEqual(i.ogValues)?e.parseExpression(t.key,this.model).set(_.first(i.ogValues)):t.placeholder="—",t}function q(e){e.items?e.items.forEach(q):D(e,"—")}function A(t){var i=this,n=t.schema.type,s=t.batchConfig;if("array"===n)s.editModes=s.editModes||["replace","append"],s["default"]=s["default"]||"replace",_.allEqual(s.ogValues)?e.parseExpression(t.key,this.model).set(_.first(s.ogValues)):q(t),s.onSelect={replace:function(n){n&&"append"!==n&&e.parseExpression(t.key,i.model).set([])},append:function(n){"replace"!==n&&e.parseExpression(t.key,i.model).set([])},remove:function(){var n=_.chain(t.batchConfig.ogValues).flatten().uniq().value();e.parseExpression(t.key,i.model).set(n)}};else{var r=_.first(s.ogValues);r&&_.allEqual(s.ogValues)&&e.parseExpression(t.key,this.model).set(r),t.placeholder||D(t,"—")}return t}function L(t){var i=t.batchConfig;return _.allEqual(i.ogValues)?e.parseExpression(t.key,this.model).set(_.first(i.ogValues)):D(t,"—"),t}function T(t){var i=t.batchConfig;return _.allEqual(i.ogValues)&&e.parseExpression(t.key,this.model).set(_.first(i.ogValues)),t}function B(){var e=this;this.schema.schema.required=void 0,_.each(this.schema.schema.properties,this.clearSchemaDefault.bind(this)),console.log("this.defaults:",this.defaults),this.schema.schema.properties.__batchConfig={type:"object",properties:{}},this.schema.schema.properties.__dirtyCheck={type:"object",properties:{}},s.$on("schemaFormBeforeAppendToArray",function(t,i){return e.restoreDefaults(i)}),s.$on("schemaFormAfterAppendToArray",function(t,i){return e.resetDefaults(i)})}function I(t){var i=this;t.items&&t.items.forEach(function(t){if(t.key){if(t.schema){var n=e.getKey(t.key).replace(/\[\d+]/g,"[]");t.schema["default"]=i.defaults[n]}t.placeholder=t._placeholder,t.noBatchPlaceholder=!0}i.restoreDefaults(t)})}function N(e){var t=this;e.items&&e.items.forEach(function(e){e.schema&&(e.schema["default"]=void 0),t.resetDefaults(e)})}function O(e,t){if(this.defaults[t]=e["default"],e["default"]=void 0,"object"===e.type&&e.properties){e.required=void 0;for(var i in e.properties)this.clearSchemaDefault(e.properties[i],t+"."+i)}else"array"===e.type&&e.items&&this.clearSchemaDefault(e.items,t+"[]")}function W(e,t){var i=this;this.results=e,this.resultsConfig=t,this.modal&&this.modal.close(),this.modal=o.open({controller:"BatchResults",controllerAs:"vm",templateUrl:"cn-batch-forms/batch-results.html",resolve:{parent:function(){return i}}})}function K(){this.modal.close(),this.results=[],this.resultsConfig=null}function U(){this.schema.meta='\n          <div class="well">\n            <h5>Edit Modes</h5>\n            <p>Some types of fields allow you to apply batch changes in\n            different ways:</p>\n            <dl>\n              <dt>Replace:</dt>\n              <dd>Replace all the original values\n              with the new value. <em>(If you don\'t see an <b>Edit Mode</b> option\n              for a field, this will be the default)</em></dd>\n            </dl>\n            '+this.getEditModeLegends()+"\n          </div>"}function z(){var e="";return this.editModes.prepend&&(e+="\n            <dl>\n              <dt>Prepend:</dt>\n              <dd>Add the new value to the start of the original\n              values for each item.</dd>\n            </dl>"),this.editModes.append&&(e+="\n            <dl>\n              <dt>Append:</dt>\n              <dd>Affix the new value at the end of the original\n              values for each item.</dd>\n            </dl>"),this.editModes.decrease&&(e+="\n            <dl>\n              <dt>Decrease:</dt>\n              <dd>Subtract the given value from the original\n              values for each item.</dd>\n            </dl>"),this.editModes.increase&&(e+="\n            <dl>\n              <dt>Increase:</dt>\n              <dd>Add the given value to the original\n              values for each item.</dd>\n            </dl>"),e}var J=0;return{augmentSchema:a}}angular.module("cn.batch-forms").provider("cnBatchForms",e);var i={string:"processDefault",number:"processNumber",url:"processDefault",array:"processSelect","cn-autocomplete":"processSelect","cn-currency":"processNumber","cn-datetimepicker":"processDate","cn-toggle":"processToggle"};t.$inject=["cnFlexFormService","cnFlexFormTypes","sfPath","$rootScope","$timeout","cnModal"]}(),angular.module("cn.batch-forms").run(["$templateCache",function(e){e.put("cn-batch-forms/batch-results.html",'<div class="cn-modal">\n  <div class="modal-header clearfix">\n    <cn-flex-form-header\n      ff-header-config="vm.headerConfig"\n      ff-submit="vm.submit(handler)">\n    </cn-flex-form-header>\n  </div>\n  <div class="modal-body cn-list card-flex"\n       cn-responsive-height="80"\n       cn-responsive-break="sm"\n       cn-set-max-height>\n\n    <div class="padding-20"\n         ng-if="vm.text">\n      <p class="no-margin text-mute"\n         ng-bind-html="vm.text">\n      </p>\n    </div>\n\n    <table class="table gutterless">\n      <tbody>\n      <tr ng-repeat="result in vm.results">\n        <td class="col-sm-10">\n          <h6 ng-show="result.status == 200">\n            {{result.body[vm.displayName]}}\n            <span class="text-mute">({{result.body.id}})</span>\n          </h6>\n          <h6 ng-show="result.status != 200">\n            {{vm.originals[$index][vm.displayName]}}\n            <span class="text-mute">({{vm.originals[$index].id}})</span>\n          </h6>\n          <p ng-class="{\n               \'text-danger\': result.status != 200,\n               \'text-primary\': result.status == 200\n             }">\n            <i class="fa fa-{{result.status == 200 ? \'check\' : \'times\'}}"></i>\n            {{result.status == 200 ? \'updated successfully\' : result.body.message}}\n          </p>\n        </td>\n        <td class="col-sm-2 text-center">\n          <a ng-show="result.editSref"\n             class="btn btn-sm btn-transparent"\n             ui-sref="{{result.editSref}}">\n            <i class="icn-edit"></i>\n          </a>\n        </td>\n      </tr>\n      </tbody>\n    </table>\n  </div>\n</div>\n')}]);
//# sourceMappingURL=all.min.js.map
